<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OMDb proxy – test UI</title>
	<style>
		* { box-sizing: border-box; }
		body { font-family: system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 1.5rem; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
		h1 { font-size: 1.25rem; margin: 0 0 1rem 0; }
		input[type="text"], input[type="password"], button { padding: 0.5rem 0.75rem; border-radius: 6px; border: 1px solid #475569; font-size: 0.9rem; }
		input { background: #1e293b; color: #e2e8f0; width: 100%; }
		button { background: #6366f1; color: white; border: none; cursor: pointer; font-weight: 600; }
		button:hover { background: #4f46e5; }
		button.secondary { background: #334155; }
		button.secondary:hover { background: #475569; }
		#login-box { background: #1e293b; padding: 1.5rem; border-radius: 12px; max-width: 320px; }
		#login-box label { display: block; margin-bottom: 0.5rem; font-size: 0.85rem; color: #94a3b8; }
		#login-box input { margin-bottom: 1rem; }
		#app { display: none; }
		#app.unlocked { display: block; }
		.search-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
		.search-row input { flex: 1; }
		.error { color: #f87171; font-size: 0.9rem; margin-top: 0.5rem; }
		.results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
		.result-card { background: #1e293b; border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.15s; border: 1px solid #334155; }
		.result-card:hover { transform: scale(1.02); border-color: #6366f1; }
		.result-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; display: block; background: #334155; }
		.result-card .meta { padding: 0.5rem; font-size: 0.8rem; }
		.result-card .title { font-weight: 600; margin-bottom: 0.2rem; line-height: 1.2; }
		.result-card .year { color: #94a3b8; }
		#detail { margin-top: 1.5rem; padding: 1.25rem; background: #1e293b; border-radius: 12px; display: none; border: 1px solid #334155; }
		#detail.visible { display: block; }
		#detail .detail-header { display: flex; gap: 1.25rem; flex-wrap: wrap; margin-bottom: 1rem; }
		#detail .detail-poster { width: 200px; border-radius: 8px; flex-shrink: 0; }
		#detail .detail-poster img { width: 100%; border-radius: 8px; }
		#detail .detail-info { flex: 1; min-width: 240px; }
		#detail h2 { margin: 0 0 0.5rem 0; font-size: 1.35rem; }
		#detail .detail-meta { color: #94a3b8; font-size: 0.9rem; margin-bottom: 0.75rem; }
		#detail .detail-plot { font-size: 0.95rem; line-height: 1.55; margin-bottom: 1rem; }
		#detail .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 0.75rem 1.5rem; font-size: 0.9rem; }
		#detail .detail-grid .row { display: flex; gap: 0.5rem; }
		#detail .detail-grid .label { color: #94a3b8; flex-shrink: 0; min-width: 5rem; }
		#detail .detail-grid .value { color: #e2e8f0; }
		#detail .detail-actions { margin-top: 1rem; display: flex; gap: 0.75rem; flex-wrap: wrap; }
		#detail .detail-actions a { color: #818cf8; text-decoration: none; font-size: 0.9rem; }
		#detail .detail-actions a:hover { text-decoration: underline; }
		.cinematerial-section { margin-top: 1.25rem; padding-top: 1rem; border-top: 1px solid #334155; }
		.cinematerial-section h3 { font-size: 1rem; margin: 0 0 0.5rem 0; color: #94a3b8; }
		.cinematerial-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.75rem; }
		.cinematerial-actions a { color: #818cf8; font-size: 0.9rem; }
		.posters-cinematerial { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.75rem; }
		.posters-cinematerial img { width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 6px; background: #334155; }
		.posters-cinematerial .poster-placeholder { aspect-ratio: 2/3; background: #334155; border-radius: 6px; }
		.api-info { margin-top: 1.5rem; padding: 1rem; background: #1e293b; border-radius: 8px; font-size: 0.85rem; color: #94a3b8; border: 1px solid #334155; }
		.api-info strong { color: #e2e8f0; }
		.api-info a { color: #818cf8; }
		.api-info code { background: #0f172a; padding: 0.1rem 0.35rem; border-radius: 4px; font-size: 0.8rem; }
		.hint { color: #94a3b8; font-size: 0.85rem; margin-top: 0.5rem; }
		#status { min-height: 1.5rem; font-size: 0.85rem; color: #94a3b8; }
		.usage-row { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
		#usage-display { font-size: 0.85rem; color: #94a3b8; }
		#usage-display strong { color: #e2e8f0; }
		#stats-panel { display: none; margin-top: 1rem; padding: 1rem; background: #1e293b; border-radius: 12px; border: 1px solid #334155; }
		#stats-panel.visible { display: block; }
		.stats-summary { margin-bottom: 1rem; font-size: 0.85rem; }
		.stats-summary p { margin: 0.25rem 0; }
		.stats-filters { display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; margin-bottom: 1rem; }
		.stats-filters label { font-size: 0.85rem; color: #94a3b8; }
		.stats-filters select { padding: 0.35rem 0.5rem; border-radius: 6px; border: 1px solid #475569; background: #1e293b; color: #e2e8f0; font-size: 0.85rem; }
		.stats-table-wrap { overflow-x: auto; }
		.stats-table { width: 100%; font-size: 0.75rem; border-collapse: collapse; }
		.stats-table th, .stats-table td { padding: 0.35rem 0.5rem; text-align: left; border-bottom: 1px solid #334155; }
		.stats-table th { color: #94a3b8; font-weight: 600; }
		.stats-table td { color: #e2e8f0; }
	</style>
</head>
<body>
	<div id="login-box">
		<h1>OMDb proxy – test UI</h1>
		<p class="hint">Enter the UI secret to access the test panel.</p>
		<form id="login-form">
			<label for="secret">Secret</label>
			<input type="password" id="secret" name="secret" placeholder="UI secret" autocomplete="off">
			<div id="login-error" class="error"></div>
			<button type="submit">Unlock</button>
		</form>
	</div>

	<div id="app">
		<h1>OMDb proxy – test UI</h1>
		<div class="search-row">
			<input type="text" id="search-input" placeholder="Search movies or series…" autocomplete="off">
			<button type="button" id="search-btn">Search</button>
			<button type="button" id="logout-btn" class="secondary">Lock</button>
		</div>
		<div class="usage-row">
			<span id="usage-display" class="hint">—/1000 today</span>
			<button type="button" id="stats-btn" class="secondary">Stats</button>
		</div>
		<p class="hint" style="margin-top:0.25rem;">If the API requires a key, set it below so the test UI can call it.</p>
		<div class="search-row" style="max-width:320px;">
			<input type="password" id="api-key-input" placeholder="API key (optional)" autocomplete="off">
		</div>
		<div id="status"></div>
		<div id="stats-panel">
			<div id="stats-content"></div>
			<button type="button" id="stats-back-btn" class="secondary" style="margin-top:0.75rem;">Back</button>
		</div>
		<div id="results" class="results-grid"></div>
		<div id="detail">
			<div class="detail-header">
				<div class="detail-poster"></div>
				<div class="detail-info">
					<h2 id="detail-title"></h2>
					<div class="detail-meta" id="detail-meta"></div>
					<div class="detail-plot" id="detail-plot"></div>
					<div class="detail-grid" id="detail-grid"></div>
					<div class="detail-actions" id="detail-actions"></div>
					<div class="cinematerial-section" id="cinematerial-section">
						<h3>Poster sources</h3>
						<div class="cinematerial-actions">
							<a href="#" id="cinematerial-link" target="_blank" rel="noopener">CineMaterial</a>
							<button type="button" id="cinematerial-fetch-btn" class="secondary">Fetch / refresh posters</button>
							<a href="#" id="theposterdb-link" target="_blank" rel="noopener">ThePosterDB</a>
						</div>
						<p class="hint" style="margin:0.25rem 0 0.5rem 0;">CineMaterial: more posters, direct by IMDb ID. ThePosterDB: different coverage (search by title).</p>
						<div class="posters-cinematerial" id="posters-cinematerial"></div>
					</div>
				</div>
			</div>
		</div>
		<div class="api-info" id="api-info">
			<strong>API base (for your bot or site):</strong> <code id="api-base"></code><br>
			Key is on the server (Vercel <code>OMDB_API_KEY</code>). If you set <code>API_SECRET</code>, use the “API key” field above.<br>
			Test (open in new tab; add <code>X-API-Key</code> if API is protected): <a href="#" id="api-test-poster">Poster by title</a> · <a href="#" id="api-test-search">Search</a> · <a href="#" id="api-test-id">By ID</a>
		</div>
	</div>

	<script>
		var UI_STORAGE = 'omdb_ui_unlocked';
		var API_KEY_STORAGE = 'omdb_ui_api_key';
		var base = window.location.origin;
		var currentDetail = { imdbID: '', title: '', type: 'movie' };
		var SOURCE_PARAM = '&source=vercel_app';

		function updateUsageDisplay(usage) {
			var el = document.getElementById('usage-display');
			if (!el || !usage) return;
			var count = usage.dailyCount != null ? usage.dailyCount : '—';
			var limit = usage.dailyLimit != null ? usage.dailyLimit : 1000;
			el.innerHTML = '<strong>' + count + '</strong>/' + limit + ' today';
		}
		function fetchUsageOnly() {
			fetch(base + '/api/omdb?usage=1', { headers: getApiKeyHeaders() })
				.then(function (r) { return r.ok ? r.json() : null; })
				.then(function (data) {
					if (data && data.dailyCount != null) updateUsageDisplay(data);
				})
				.catch(function () {});
		}

		function slugify(s) {
			if (!s) return 'title';
			return String(s).trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '').replace(/-+/g, '-').replace(/^-|-$/g, '') || 'title';
		}
		function cinematerialPageUrl(imdbId, title, type) {
			var id = (imdbId || '').replace(/^tt/i, '');
			if (!/^\d+$/.test(id)) return 'https://www.cinematerial.com/';
			var path = type === 'series' ? 'tv' : 'movies';
			return 'https://www.cinematerial.com/' + path + '/' + slugify(title) + '-i' + id;
		}
		function theposterdbSearchUrl(title, type) {
			var section = type === 'series' ? 'shows' : 'movies';
			var term = encodeURIComponent((title || '').trim() || '');
			return term ? 'https://theposterdb.com/search?term=' + term + '&section=' + section : 'https://theposterdb.com/search';
		}

		function getApiKeyHeaders() {
			var key = (document.getElementById('api-key-input') && document.getElementById('api-key-input').value.trim()) || sessionStorage.getItem(API_KEY_STORAGE) || '';
			if (!key) return {};
			return { 'X-API-Key': key };
		}

		function setStatus(msg) {
			var el = document.getElementById('status');
			if (el) el.textContent = msg || '';
		}

		function checkUnlock() {
			var q = new URLSearchParams(window.location.search);
			var secret = q.get('secret');
			if (secret) {
				document.getElementById('secret').value = secret;
				document.getElementById('login-form').dispatchEvent(new Event('submit', { cancelable: true }));
				return;
			}
			if (sessionStorage.getItem(UI_STORAGE) === '1') {
				document.getElementById('login-box').style.display = 'none';
				document.getElementById('app').classList.add('unlocked');
			}
		}

		document.getElementById('login-form').addEventListener('submit', function (e) {
			e.preventDefault();
			var secret = document.getElementById('secret').value.trim();
			var errEl = document.getElementById('login-error');
			errEl.textContent = '';
			if (!secret) { errEl.textContent = 'Enter the secret.'; return; }
			fetch(base + '/api/auth?secret=' + encodeURIComponent(secret))
				.then(function (r) {
					if (r.ok) {
						sessionStorage.setItem(UI_STORAGE, '1');
						document.getElementById('login-box').style.display = 'none';
						document.getElementById('app').classList.add('unlocked');
					} else {
						errEl.textContent = 'Invalid secret.';
					}
				})
				.catch(function () { errEl.textContent = 'Network error.'; });
		});

		document.getElementById('logout-btn').addEventListener('click', function () {
			sessionStorage.removeItem(UI_STORAGE);
			location.reload();
		});

		function search() {
			var q = document.getElementById('search-input').value.trim();
			if (!q) { setStatus('Enter a search term.'); return; }
			setStatus('Searching…');
			document.getElementById('results').innerHTML = '';
			document.getElementById('detail').classList.remove('visible');
			fetch(base + '/api/omdb?s=' + encodeURIComponent(q) + SOURCE_PARAM, { headers: getApiKeyHeaders() })
				.then(function (r) { return r.json(); })
				.then(function (data) {
					if (data && data.usage) updateUsageDisplay(data.usage);
					var list = (data && data.results) ? data.results : [];
					if (data && data.error) { setStatus(data.error); return; }
					setStatus(list.length ? 'Found ' + list.length + ' results.' : 'No results.');
					var grid = document.getElementById('results');
					list.forEach(function (item) {
						var card = document.createElement('div');
						card.className = 'result-card';
						var img = item.Poster && item.Poster.indexOf('http') === 0
							? '<img src="' + item.Poster.replace(/"/g, '&quot;') + '" alt="" loading="lazy">'
							: '<div style="aspect-ratio:2/3;background:#334155;"></div>';
						card.innerHTML = img + '<div class="meta"><div class="title">' + (item.Title || '').replace(/</g, '&lt;') + '</div><div class="year">' + (item.Year || '').replace(/</g, '&lt;') + '</div></div>';
						card.addEventListener('click', function () { showDetail(item.imdbID); });
						grid.appendChild(card);
					});
				})
				.catch(function () { setStatus('Network error.'); });
		}

		function esc(s) { return (s || '').replace(/</g, '&lt;').replace(/"/g, '&quot;'); }
		function row(label, value) {
			if (!value || value === 'N/A') return '';
			return '<div class="row"><span class="label">' + esc(label) + '</span><span class="value">' + esc(value) + '</span></div>';
		}

		function showDetail(imdbID) {
			if (!imdbID) return;
			setStatus('Loading…');
			document.getElementById('detail').classList.remove('visible');
			fetch(base + '/api/omdb?i=' + encodeURIComponent(imdbID) + SOURCE_PARAM, { headers: getApiKeyHeaders() })
				.then(function (r) { return r.json(); })
				.then(function (data) {
					if (data && data.usage) updateUsageDisplay(data.usage);
					if (data && data.error) { setStatus(data.error); return; }
					setStatus('');
					var d = document.getElementById('detail');
					var poster = (data.Poster && data.Poster.indexOf('http') === 0)
						? '<img src="' + data.Poster.replace(/"/g, '&quot;') + '" alt="">'
						: '<div style="aspect-ratio:2/3;background:#334155;border-radius:8px;"></div>';
					document.querySelector('#detail .detail-poster').innerHTML = poster;
					document.getElementById('detail-title').textContent = (data.Title || '') + (data.Year ? ' (' + data.Year + ')' : '');
					var meta = [];
					if (data.Rated && data.Rated !== 'N/A') meta.push('Rated: ' + data.Rated);
					if (data.Runtime && data.Runtime !== 'N/A') meta.push(data.Runtime);
					if (data.Genre && data.Genre !== 'N/A') meta.push(data.Genre);
					if (data.imdbRating && data.imdbRating !== 'N/A') meta.push('IMDb: ' + data.imdbRating);
					document.getElementById('detail-meta').textContent = meta.join(' · ');
					document.getElementById('detail-plot').textContent = (data.Plot && data.Plot !== 'N/A') ? data.Plot : '';

					var grid = document.getElementById('detail-grid');
					grid.innerHTML = row('Released', data.Released) + row('Director', data.Director) + row('Writer', data.Writer) +
						row('Actors', data.Actors) + row('Language', data.Language) + row('Country', data.Country) +
						row('Awards', data.Awards) + row('Box office', data.BoxOffice) + row('Type', data.Type) + row('imdbID', data.imdbID);

					var actions = document.getElementById('detail-actions');
					var detailUrl = base + '?i=' + encodeURIComponent(data.imdbID || imdbID);
					actions.innerHTML = '<a href="' + detailUrl + '" target="_blank" rel="noopener">Open in new tab</a>' +
						(data.imdbID ? '<a href="https://www.imdb.com/title/' + esc(data.imdbID) + '/" target="_blank" rel="noopener">View on IMDb</a>' : '');

					currentDetail = { imdbID: data.imdbID || imdbID, title: data.Title || '', type: (data.Type || 'movie').toLowerCase() };
					if (currentDetail.type === 'series') currentDetail.type = 'series';
					else currentDetail.type = 'movie';
					document.getElementById('cinematerial-link').href = cinematerialPageUrl(currentDetail.imdbID, currentDetail.title, currentDetail.type);
					document.getElementById('theposterdb-link').href = theposterdbSearchUrl(currentDetail.title, currentDetail.type);
					document.getElementById('posters-cinematerial').innerHTML = '';

					d.classList.add('visible');
					d.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
				})
				.catch(function () { setStatus('Network error.'); });
		}

		function fetchCineMaterial() {
			var el = document.getElementById('posters-cinematerial');
			if (!currentDetail.imdbID) { el.innerHTML = '<span class="hint">Select a title first.</span>'; return; }
			el.innerHTML = '<span class="hint">Loading…</span>';
			var q = 'i=' + encodeURIComponent(currentDetail.imdbID) + '&title=' + encodeURIComponent(currentDetail.title) + '&type=' + encodeURIComponent(currentDetail.type);
			fetch(base + '/api/cinematerial?' + q, { headers: getApiKeyHeaders() })
				.then(function (r) { return r.json(); })
				.then(function (data) {
					var list = (data && data.posters) ? data.posters : [];
					if (data && data.error && list.length === 0) {
						el.innerHTML = '<span class="hint">' + esc(data.error) + ' Use “Open on CineMaterial” to browse and filter on the site.</span>';
						return;
					}
					if (list.length === 0) {
						el.innerHTML = '<span class="hint">No poster URLs found on the page. Use “Open on CineMaterial” to view and filter posters there.</span>';
						return;
					}
					var html = '';
					list.forEach(function (p) {
						var u = (p && p.url) ? p.url : p;
						html += '<img src="' + esc(u) + '" alt="" loading="lazy">';
					});
					el.innerHTML = html;
				})
				.catch(function () {
					el.innerHTML = '<span class="hint">Network error. Try again or open CineMaterial directly.</span>';
				});
		}

		document.getElementById('cinematerial-fetch-btn').addEventListener('click', fetchCineMaterial);
		document.getElementById('search-btn').addEventListener('click', search);
		document.getElementById('search-input').addEventListener('keydown', function (e) { if (e.key === 'Enter') search(); });

		function initApiInfo() {
			document.getElementById('api-base').textContent = base + '/api/omdb';
			document.getElementById('api-test-poster').href = base + '/api/omdb?t=Inception';
			document.getElementById('api-test-poster').target = '_blank';
			document.getElementById('api-test-search').href = base + '/api/omdb?s=batman';
			document.getElementById('api-test-search').target = '_blank';
			document.getElementById('api-test-id').href = base + '/api/omdb?i=tt1375666';
			document.getElementById('api-test-id').target = '_blank';
			fetchUsageOnly();
		}

		function showStatsPanel(show) {
			var panel = document.getElementById('stats-panel');
			var results = document.getElementById('results');
			var detail = document.getElementById('detail');
			if (show) {
				panel.classList.add('visible');
				if (results) results.style.display = 'none';
				if (detail) detail.style.display = 'none';
			} else {
				panel.classList.remove('visible');
				if (results) results.style.display = '';
				if (detail) detail.style.display = '';
			}
		}

		function renderStatsDashboard(data) {
			var daily = data.daily || {};
			var dates = Object.keys(daily).sort().reverse();
			var catFilter = (document.getElementById('stats-cat-filter') && document.getElementById('stats-cat-filter').value) || 'all';
			var srcFilter = (document.getElementById('stats-src-filter') && document.getElementById('stats-src-filter').value) || 'all';
			var cats = ['movies', 'kdrama', 'anime', 'bollywood'];
			var catLabel = { movies: 'Movies', kdrama: 'K-drama', anime: 'Anime', bollywood: 'Bollywood' };
			var sources = ['website', 'vercel_app', 'manual', 'form_bot', 'other'];
			var srcLabel = { website: 'Website', vercel_app: 'Vercel app', manual: 'Manual', form_bot: 'Form bot', other: 'Other' };

			var today = new Date().toISOString().slice(0, 10);
			var todayRow = daily[today];
			var todayCount = todayRow ? todayRow.count : 0;
			var summary = '<div class="stats-summary"><p><strong>Summary</strong></p>';
			summary += '<p>Today: <strong>' + todayCount + '</strong> / ' + (data.dailyLimit || 1000) + ' &middot; Weekly: <strong>' + (data.weeklyTotal || 0) + '</strong> &middot; Monthly: <strong>' + (data.monthlyTotal || 0) + '</strong></p>';
			if (catFilter !== 'all') {
				var catTotal = 0;
				dates.forEach(function (d) {
					var row = daily[d];
					if (row && row.byCategory && row.byCategory[catFilter] != null) catTotal += row.byCategory[catFilter];
				});
				summary += '<p>' + (catLabel[catFilter] || catFilter) + ' total: <strong>' + catTotal + '</strong></p>';
			}
			if (srcFilter !== 'all') {
				var srcTotal = 0;
				dates.forEach(function (d) {
					var row = daily[d];
					if (row && row.bySource && row.bySource[srcFilter] != null) srcTotal += row.bySource[srcFilter];
				});
				summary += '<p>' + (srcLabel[srcFilter] || srcFilter) + ' total: <strong>' + srcTotal + '</strong></p>';
			}
			summary += '</div>';

			var filterHtml = '<div class="stats-filters">';
			filterHtml += '<label>Category:</label><select id="stats-cat-filter"><option value="all"' + (catFilter === 'all' ? ' selected' : '') + '>All</option>';
			cats.forEach(function (c) {
				filterHtml += '<option value="' + c + '"' + (catFilter === c ? ' selected' : '') + '>' + (catLabel[c] || c) + '</option>';
			});
			filterHtml += '</select>';
			filterHtml += '<label>Source:</label><select id="stats-src-filter"><option value="all"' + (srcFilter === 'all' ? ' selected' : '') + '>All</option>';
			sources.forEach(function (s) {
				filterHtml += '<option value="' + s + '"' + (srcFilter === s ? ' selected' : '') + '>' + (srcLabel[s] || s) + '</option>';
			});
			filterHtml += '</select></div>';

			var table = '<div class="stats-table-wrap"><table class="stats-table"><thead><tr>';
			table += '<th>Date</th><th>Total</th><th>Search</th><th>Detail</th><th>Poster</th>';
			sources.forEach(function (s) { table += '<th>' + (srcLabel[s] || s) + '</th>'; });
			cats.forEach(function (c) { table += '<th>' + (catLabel[c] || c) + '</th>'; });
			table += '</tr></thead><tbody>';
			dates.forEach(function (d) {
				var row = daily[d];
				if (!row) return;
				var byType = row.byType || {};
				var byCat = row.byCategory || {};
				var bySrc = row.bySource || {};
				table += '<tr><td>' + esc(d) + '</td><td>' + (row.count || 0) + '</td>';
				table += '<td>' + (byType.search || 0) + '</td><td>' + (byType.detail || 0) + '</td><td>' + (byType.poster || 0) + '</td>';
				sources.forEach(function (s) { table += '<td>' + (bySrc[s] || 0) + '</td>'; });
				cats.forEach(function (c) { table += '<td>' + (byCat[c] || 0) + '</td>'; });
				table += '</tr>';
			});
			table += '</tbody></table></div>';

			document.getElementById('stats-content').innerHTML = summary + filterHtml + table;
			document.getElementById('stats-cat-filter').onchange = function () { renderStatsDashboard(data); };
			document.getElementById('stats-src-filter').onchange = function () { renderStatsDashboard(data); };
		}

		document.getElementById('stats-btn').addEventListener('click', function () {
			showStatsPanel(true);
			document.getElementById('stats-content').innerHTML = '<p class="hint">Loading stats…</p>';
			fetch(base + '/api/omdb?stats=1', { headers: getApiKeyHeaders() })
				.then(function (r) { return r.ok ? r.json() : null; })
				.then(function (data) {
					if (!data || !data.daily || Object.keys(data.daily).length === 0) {
						document.getElementById('stats-content').innerHTML = '<p class="hint">No stats yet. Use search or detail to build data.</p>';
						return;
					}
					renderStatsDashboard(data);
				})
				.catch(function () {
					document.getElementById('stats-content').innerHTML = '<p class="hint">Could not load stats.</p>';
				});
		});
		document.getElementById('stats-back-btn').addEventListener('click', function () {
			showStatsPanel(false);
		});

		function checkDetailFromUrl() {
			var q = new URLSearchParams(window.location.search);
			var id = q.get('i');
			if (id && /^tt\d+$/.test(id)) showDetail(id);
		}

		checkUnlock();
		if (document.getElementById('app').classList.contains('unlocked')) {
			var savedKey = sessionStorage.getItem(API_KEY_STORAGE);
			if (savedKey && document.getElementById('api-key-input')) document.getElementById('api-key-input').value = savedKey;
			initApiInfo();
			checkDetailFromUrl();
		}
		document.getElementById('api-key-input').addEventListener('input', function () {
			var v = this.value.trim();
			if (v) sessionStorage.setItem(API_KEY_STORAGE, v);
			else sessionStorage.removeItem(API_KEY_STORAGE);
		});
		document.getElementById('login-form').addEventListener('submit', function () {
			setTimeout(function () {
				if (document.getElementById('app').classList.contains('unlocked')) {
					var savedKey = sessionStorage.getItem(API_KEY_STORAGE);
					if (savedKey && document.getElementById('api-key-input')) document.getElementById('api-key-input').value = savedKey;
					initApiInfo();
					checkDetailFromUrl();
				}
			}, 0);
		});
	</script>
</body>
</html>
